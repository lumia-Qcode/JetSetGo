{% extends "base.html" %}
{% block title %}Budget{% endblock %}

{% block content %}
<div class="container mt-4">
    <h2>üí∞ Budget for {{ trip.title }}</h2>
    <p><b>Destination:</b> {{ trip.destination }}</p>
    <p><b>Dates:</b> {{ trip.start_date }} ‚Üí {{ trip.end_date }}</p>
    <hr>

    <!-- Summary -->
    <div class="card p-3 mb-3">
        <p>
            <b>Total Planned:</b> {{ trip.budget.total_planned }} |
            <b>Total Spent:</b> {{ trip.budget.total_spent }} |
            <b>Remaining:</b> {{ trip.budget.calculate_remaining() }}
        </p>
    </div>

    <!-- Planned Budgets -->
<h3>Planned Budgets</h3>
{% if trip.budget.planned_budgets|length == 0 %}
    <p class="text-muted">No planned budgets yet.</p>
{% else %}
    <ul class="list-group mb-3">
      {% for pb in trip.budget.planned_budgets %}
        <li class="list-group-item d-flex justify-content-between align-items-center">
          <div>
            <b>{{ pb.category }}</b> ‚Äî ${{ pb.amount }}
          </div>
          <div>
            <!-- Edit and Delete buttons -->
            <a href="{{ url_for('trips.update_planned_budget', planned_budget_id=pb.id) }}" class="btn btn-primary btn-sm"> Edit </a>


            <form action="{{ url_for('trips.delete_planned_budget', planned_budget_id=pb.id) }}" method="POST"
                  onsubmit="return confirm('Delete this planned budget?');" class="d-inline">
                <button class="btn btn-danger btn-sm">Delete</button>
            </form>
          </div>
        </li>
      {% endfor %}
    </ul>
{% endif %}

<!-- Add Planned Budget -->
<div class="card p-3 mb-4">
    <h5>Add Planned Budget</h5>
    <form action="{{ url_for('trips.add_planned_budget', trip_id=trip.id) }}" method="POST" id="plannedBudgetForm">
        <div class="row">
            <div class="col-md-4 mb-2">
                <label for="suggestedCategory" class="form-label">Select Category</label>
                <select name="category" id="suggestedCategory" class="form-select">
                    <option value="" disabled selected>-- Choose or write below --</option>
                    <option value="Food">Food</option>
                    <option value="Transport">Transport</option>
                    <option value="Accommodation">Accommodation</option>
                    <option value="Shopping">Shopping</option>
                    <option value="Entertainment">Entertainment</option>
                    <option value="Miscellaneous">Miscellaneous</option>
                </select>
            </div>

            <div class="col-md-4 mb-2">
                <label for="customCategory" class="form-label">Or enter custom category</label>
                <input type="text" id="customCategory" class="form-control" placeholder="Custom category (optional)">
            </div>

            <div class="col-md-4 mb-2">
                <label for="plannedAmount" class="form-label">Amount</label>
                <input type="number" name="amount" step="0.01" min="0" required id="plannedAmount" class="form-control">
            </div>
        </div>
        <button type="submit" class="btn btn-success mt-2">Add Planned Budget</button>
    </form>
</div>

<script>
/* Allow user to write custom category and override dropdown */
document.getElementById('plannedBudgetForm').addEventListener('submit', function (e) {
    const customCategory = document.getElementById('customCategory').value.trim();
    const select = document.getElementById('suggestedCategory');
    if (customCategory) {
        // If user typed a custom category, replace the select‚Äôs value before submitting
        const tempOption = document.createElement('option');
        tempOption.value = customCategory;
        tempOption.text = customCategory;
        tempOption.selected = true;
        select.appendChild(tempOption);
    }
});
</script>


    <!-- Chart -->
    <div class="card p-3 mb-3">
        <h5>Expense Breakdown</h5>
        <!-- Reduced canvas size to make the pie chart smaller. -->
        <!-- Styles and chart options also set maintainAspectRatio=false to respect these dimensions. -->
        <canvas id="budgetChart" width="300" height="150" style="max-width:300px;max-height:180px;"></canvas>
    </div>

    <!-- Export CSV Button -->
    <div class="mb-3">
        <button type="button" class="btn btn-info" onclick="exportCSV()">Export as CSV</button>
    </div>

    <!-- Expenses -->
    <h3>Expenses</h3>
    {% if trip.budget.expenses|length == 0 %}
        <p class="text-muted">No expenses yet.</p>
    {% else %}
        <ul class="list-group mb-3">
          {% for expense in trip.budget.expenses %}
            <li class="list-group-item d-flex justify-content-between align-items-center">
              <div>
                <b>{{ expense.description }}</b> - ${{ expense.amount }}
                {% if expense.shared_users %}
                  <p class="mb-1">
                    Shared with: 
                    {{ expense.shared_users | map(attribute='username') | join(', ') }} ({{ expense.status }})
                  </p>

                  {% if expense.status == "Pending" and expense.shared_users | map(attribute='username') | join(', ') == session['user_name'] %}
                    <form action="{{ url_for('trips.respond_share', expense_id=expense.id, response='accept') }}" method="post" class="d-inline">
                      <button type="submit" class="btn btn-success btn-sm">Accept</button>
                    </form>
                    <form action="{{ url_for('trips.respond_share', expense_id=expense.id, response='reject') }}" method="post" class="d-inline">
                      <button type="submit" class="btn btn-warning btn-sm">Reject</button>
                    </form>
                  {% endif %}
                {% endif %}
              </div>
              <div>
                <!-- Edit button -->
                <a href="{{ url_for('trips.edit_expense', expense_id=expense.id) }}" class="btn btn-primary btn-sm"> Edit </a>
                <!-- Leave button -->
                <form action="{{ url_for('trips.leave_expense', expense_id=expense.id) }}" method="POST"
                      onsubmit="return confirm('Leave this shared expense?');" class="d-inline">
                    <button class="btn btn-warning btn-sm">Leave</button>
                </form>
                <!-- Delete button -->
                <form action="{{ url_for('trips.delete_expense', expense_id=expense.id) }}" method="POST"
                      onsubmit="return confirm('Delete this expense?');" class="d-inline">
                    <button class="btn btn-danger btn-sm">Delete</button>
                </form>
              </div>
            </li>
          {% endfor %}
        </ul>
    {% endif %}

    <!-- Add Expense -->
    <div class="card p-3">
        <h5>Add Expense</h5>
        <form action="{{ url_for('trips.trip_budget', trip_id=trip.id) }}" method="POST" class="mb-4">
            <input type="number" name="amount" step="0.01" placeholder="Amount" required class="form-control mb-2">
            <input type="text" name="category" placeholder="Category" class="form-control mb-2">
            <input type="text" name="description" placeholder="Description" class="form-control mb-2">
            <input type="text" name="shared_with" placeholder="Shared with (comma-separated)" class="form-control mb-2">
            <button type="submit" class="btn btn-success">Add Expense</button>
        </form>
    </div>
</div>

<!-- Back to Trip Detail -->
<div class="text-end mb-3">
    <a href="{{ url_for('trips.trip_detail', trip_id=trip.id) }}" class="btn btn-outline-secondary">
        ‚Üê Back to Trip Details
    </a>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>


<!-- Server-rendered expenses as JSON to avoid embedding Jinja in JS -->
<script id="expenses-data" type="application/json"
    data-trip-title="{{ trip.title|e }}"
    data-total-spent="{{ trip.budget.total_spent|default(0) }}"
    data-remaining="{{ trip.budget.calculate_remaining()|default(0) }}">
[
{%- for e in trip.budget.expenses %}
    {{ ({'description': e.description|default(''), 'amount': (e.amount|default(0)), 'category': e.category|default('')})|tojson }}{{ "," if not loop.last else "" }}
{%- endfor %}
]
</script>

<script>
var categoryData = {};
var expenses = [];

// Populate categoryData and expenses from server-rendered JSON
var _dataEl = document.getElementById('expenses-data');
if (_dataEl) {
    try {
        var serverExpenses = JSON.parse(_dataEl.textContent) || [];
        serverExpenses.forEach(function(expense) {
            var category = expense.category || 'Uncategorized';
            var amount = Number(expense.amount) || 0;
            categoryData[category] = (categoryData[category] || 0) + amount;
            expenses.push({
                description: expense.description || '',
                amount: amount,
                category: expense.category || ''
            });
        });
    } catch (err) {
        console.error('Failed to parse expenses JSON', err);
    }
}

var labels = Object.keys(categoryData);
var data = Object.values(categoryData);
//*************************alizeh************************
// Create the pie chart. Chart size is reduced by smaller canvas dimensions
// and disabling maintainAspectRatio so Chart.js will use the canvas size.
var ctx = document.getElementById('budgetChart').getContext('2d');
var budgetChart = new Chart(ctx, {
    type: 'pie',
    data: {
        labels: labels,
        datasets: [{
            data: data,
            backgroundColor: [
                '#FF6384',
                '#36A2EB',
                '#FFCE56',
                '#4BC0C0',
                '#9966FF',
                '#FF9F40'
            ]
        }]
    },
    options: {
        responsive: true,
        // Let the chart fill the (smaller) canvas rather than enforcing original aspect ratio
        maintainAspectRatio: false,
        plugins: {
            legend: {
                display: false,
            }
        }
    },
});

var total = data.reduce((a, b) => a + b, 0);
var legendHtml = '<div class="d-flex flex-wrap justify-content-center mt-3">';
labels.forEach(function(label, index) {
    var percentage = ((data[index] / total) * 100).toFixed(1);
    var color = budgetChart.data.datasets[0].backgroundColor[index];
    legendHtml += `
        <div class="m-2 d-flex align-items-center">
            <div style="width:15px;height:15px;background-color:${color};
                        margin-right:6px;border-radius:3px;"></div>
            <span><b>${label}</b>: ${percentage}%</span>
        </div>`;
});
legendHtml += '</div>';

// Insert below the chart
var legendContainer = document.createElement('div');
legendContainer.innerHTML = legendHtml;
document.getElementById('budgetChart').parentNode.appendChild(legendContainer);

//*************************alizeh************************
// exportCSV() explanation:
// - Uses the `expenses` array populated from the server-rendered JSON in
//   the <script id="expenses-data"> tag. This avoids embedding Jinja inside
//   JavaScript loops and prevents errors when fields contain quotes/newlines.
// - Builds a simple CSV with a small header (report title and date range),
//   a Summary section and an Expenses section. Fields are concatenated with
//   commas; if you need robust CSV escaping for fields that can contain
//   commas/quotes/newlines, consider adding a CSV-escape helper that wraps
//   fields in double-quotes and doubles internal quotes.
// - The current filename uses the server-side trip title; for stricter
//   safety you can URL-encode or sanitize the filename (replace spaces, remove
//   special chars). See the alternative implementation I can add if you'd
//   like automatic filename sanitization and safer CSV escaping.
function exportCSV() {
    var csv = 'Budget Report - {{ trip.title }}\n';
    csv += 'Date Range: {{ trip.start_date }} to {{ trip.end_date }}\n\n';
    csv += 'Summary\n';
    csv += 'Total Planned,{{ trip.budget.total_planned }}\n';
    csv += 'Total Spent,{{ trip.budget.total_spent }}\n';
    csv += 'Remaining,{{ trip.budget.calculate_remaining() }}\n\n';
    csv += 'Expenses\n';
    csv += 'Description,Amount,Category\n';
    
    expenses.forEach(function(expense) {
        // Note: this simple concatenation assumes fields do not contain commas or quotes.
        csv += (expense.description || '') + ',' + (expense.amount || '') + ',' + (expense.category || '') + '\n';
    });
    
    var element = document.createElement('a');
    element.setAttribute('href', 'data:text/csv;charset=utf-8,' + encodeURIComponent(csv));
    // Filename uses the trip title; consider sanitizing for production.
    element.setAttribute('download', '{{ trip.title }}_budget.csv');
    element.style.display = 'none';
    document.body.appendChild(element);
    element.click();
    document.body.removeChild(element);
}
</script>

{% endblock %}