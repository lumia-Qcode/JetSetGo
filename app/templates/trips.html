{% extends "base.html" %}
{% block title %}My Trips{% endblock %}

{% block content %}
<div class="container mt-4">
  <h2 class="mb-4 text-center">‚úàÔ∏è My Trips</h2>

  <!-- Flash messages -->
  {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
      {% for category, message in messages %}
        <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
          {{ message }}
          <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
      {% endfor %}
    {% endif %}
  {% endwith %}

  <!-- Trips Grid -->
  {% if trips|length == 0 %}
    <div class="alert alert-info text-center">
      You haven't joined any trips yet. üåç
    </div>
  {% else %}
    <div class="row row-cols-1 row-cols-md-3 g-4">
      {% for trip in trips %}
        {% set participant_ids = trip.participants | map(attribute='id') | list %}
        {% if session['user_id'] in participant_ids %}
          <div class="col">
            <div class="card shadow-sm h-100 position-relative">
              <div class="card-body">
              <h5 class="card-title">{{ trip.title }}</h5>
              <h6 class="card-subtitle text-muted">{% for d in trip.destinations %}{{ d.name }}{% endfor %}</h6>
              <p class="card-text mt-2">
                <b>{{ trip.start_date }}</b> - <b>{{ trip.end_date }}</b><br>
                {{ trip.description[:100] }}{% if trip.description|length > 100 %}...{% endif %}
              </p>

              {% set participant_ids = trip.participants | map(attribute='id') | list %}
              {% if participant_ids|length > 1 %}
                <span class="badge bg-info">Shared</span>
              {% endif %}

              <!-- Buttons -->
              <div class="d-flex justify-content-between align-items-center mt-3">
                <div class="d-flex gap-2">
                  <a href="{{ url_for('trips.trip_detail', trip_id=trip.id) }}" class="btn btn-primary btn-sm">
                    View
                  </a>
                  <a href="{{ url_for('trips.edit_trip', trip_id=trip.id) }}" class="btn btn-warning btn-sm">
                    Edit
                  </a>
                </div>

                <!-- Delete Trip Icon -->
                <form
                  action="{{ url_for('trips.delete_trip', trip_id=trip.id) }}"
                  method="POST"
                  onsubmit="return confirm('üóëÔ∏è Leave or delete this trip?');"
                  class="d-inline"
                >
                <button
                  type="submit"
                  class="btn btn-link p-0"
                  title="Delete Trip"
                  style="color: red;"
                >
                    <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" fill="currentColor"
                      class="bi bi-trash" viewBox="0 0 16 16">
                      <path d="M5.5 5.5A.5.5 0 0 1 6 5h4a.5.5 0 0 1 .5.5V13a1 1 0 0 1-1 1h-3a1 1 0 0 1-1-1V5.5zM4.118 4 4 4.059V13a2 2 0 0 0 2 2h4a2 2 0 0 0 2-2V4.059L11.882 4H4.118zM2.5 3a.5.5 0 0 1 .5-.5H5a1 1 0 0 1 1-1h4a1 1 0 0 1 1 1h2a.5.5 0 0 1 0 1h-12a.5.5 0 0 1-.5-.5z"/>
                    </svg>
                  </button>
                </form>
              </div>
            </div>
          </div>
        </div>
        {% endif %}
      {% endfor %}
    </div>
  {% endif %}

  <!-- Actions -->
  <div class="text-center mt-4">
    <a href="{{ url_for('trips.create_trip') }}" class="btn btn-success">Create New Trip</a>
  </div>

  <!-- Confirm delete all trips -->
  <div class="text-center mt-4">
    <a href="#" class="btn btn-danger" id="deleteAllBtn">üóëÔ∏è Delete All Trips</a>
  </div>

  <!-- Hidden confirmation card -->
  <div id="deleteConfirmCard"
    class="position-fixed top-50 start-50 translate-middle bg-white shadow-lg p-4 rounded-4 border"
    style="display:none; z-index:1050; max-width: 400px; width: 90%;">
    <h4 class="text-danger text-center mb-3">‚ö†Ô∏è Confirm Deletion</h4>
    <p>This will permanently delete <b>all your trips</b>, including itineraries, budgets, and expenses.</p>
    <form method="POST" action="{{ url_for('trips.delete_user_trips', user_id=session['user_id']) }}">
      <div class="form-group mb-3">
        <label for="password">Enter your password to confirm:</label>
        <input type="password" name="password" class="form-control" required>
      </div>
      <div class="d-flex justify-content-between">
        <button type="submit" class="btn btn-danger">Confirm</button>
        <button type="button" id="cancelDelete" class="btn btn-secondary">Cancel</button>
      </div>
    </form>
  </div>

  <script>
  document.getElementById("deleteAllBtn").addEventListener("click", function(e){
    e.preventDefault();
    document.getElementById("deleteConfirmCard").style.display = "block";
  });

  document.getElementById("cancelDelete").addEventListener("click", function(){
    document.getElementById("deleteConfirmCard").style.display = "none";
  });
  </script>
</div>
{% endblock %}
